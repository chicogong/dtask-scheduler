# dtask-scheduler

[![Go Version](https://img.shields.io/badge/Go-1.21%2B-00ADD8?style=flat&logo=go)](https://go.dev/)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)
[![Tests](https://img.shields.io/badge/Tests-31%20Passed-brightgreen)](tests/)
[![Coverage](https://img.shields.io/badge/Coverage-84--100%25-brightgreen)](tests/)

[English](README.md) | [ç®€ä½“ä¸­æ–‡](README_ZH.md)

ä¸€ä¸ªé¢å‘å¤§è§„æ¨¡æ‰¹å¤„ç†ä»»åŠ¡çš„åˆ†å¸ƒå¼ CPU/GPU ä»»åŠ¡è°ƒåº¦å™¨,æ”¯æŒè·¨æ•°åƒå°æœºå™¨çš„ç»Ÿä¸€è°ƒåº¦ã€‚

## ç‰¹æ€§

- **é›¶ä¾èµ–**: æ— éœ€ Redisã€Kafka ç­‰ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶
- **é«˜æ€§èƒ½**: äºšæ¯«ç§’çº§è°ƒåº¦å»¶è¿Ÿ (< 1ms)
- **è´Ÿè½½å‡è¡¡**: åŸºäº Worker è´Ÿè½½è‡ªåŠ¨åˆ†é…ä»»åŠ¡
- **èµ„æºåŒ¹é…**: åŸºäºæ ‡ç­¾çš„ Worker è¿‡æ»¤ (GPUã€CPUã€CUDA ç‰ˆæœ¬ç­‰)
- **ç®€å•éƒ¨ç½²**: è°ƒåº¦å™¨å’Œ Worker å„ä¸€ä¸ªç‹¬ç«‹äºŒè¿›åˆ¶æ–‡ä»¶

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| **è°ƒåº¦å»¶è¿Ÿ** | < 1ms | ä»»åŠ¡åˆ†é…ç»™ Worker çš„æ—¶é—´ |
| **ååé‡** | 1000+ è¯·æ±‚/ç§’ | æ¯ç§’å¯å¤„ç†çš„è°ƒåº¦è¯·æ±‚æ•° |
| **Worker è§„æ¨¡** | 500+ å° | å·²æµ‹è¯•çš„ Worker é›†ç¾¤è§„æ¨¡ |
| **å¿ƒè·³å¼€é”€** | 33KB/ç§’ | 500 å° Worker çš„ç½‘ç»œå¸¦å®½æ¶ˆè€— |
| **å†…å­˜å ç”¨** | < 3MB | è°ƒåº¦å™¨ç®¡ç† 500 å° Worker çš„å†…å­˜å ç”¨ |
| **è¶…æ—¶æ£€æµ‹** | 10ç§’/20ç§’ | å¯ç–‘/ç¦»çº¿çŠ¶æ€åˆ¤å®šé˜ˆå€¼ |
| **æµ‹è¯•è¦†ç›–ç‡** | 84-100% | å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•è¦†ç›–ç‡ |

## åŠŸèƒ½çŠ¶æ€

| ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æ ¸å¿ƒè°ƒåº¦å™¨ | âœ… ç”Ÿäº§å¯ç”¨ | å•è°ƒåº¦å™¨ + å†…å­˜çŠ¶æ€ç®¡ç† |
| Worker ä»£ç† | âœ… ç”Ÿäº§å¯ç”¨ | å¿ƒè·³å‘é€å™¨ + ä¼˜é›…å…³é—­ |
| èµ„æºè¿‡æ»¤ | âœ… ç”Ÿäº§å¯ç”¨ | åŸºäºæ ‡ç­¾çš„ Worker åŒ¹é… |
| è´Ÿè½½å‡è¡¡ | âœ… ç”Ÿäº§å¯ç”¨ | åŸºäºè´Ÿè½½ç‡çš„é€‰æ‹©ç®—æ³• |
| HTTP API | âœ… ç”Ÿäº§å¯ç”¨ | 3ä¸ªç«¯ç‚¹ + å®Œæ•´é”™è¯¯å¤„ç† |
| é›†æˆæµ‹è¯• | âœ… é€šè¿‡ | 31ä¸ªæµ‹è¯•,100% é€šè¿‡ç‡ |
| é«˜å¯ç”¨ | ğŸš§ è®¡åˆ’ä¸­ | å¤‡ç”¨è°ƒåº¦å™¨ + æ•…éšœåˆ‡æ¢ |
| ç›‘æ§ | ğŸš§ è®¡åˆ’ä¸­ | æŒ‡æ ‡é‡‡é›†å’Œå‘Šè­¦ |
| æ ‡ç­¾ç´¢å¼• | ğŸš§ è®¡åˆ’ä¸­ | æ€§èƒ½ä¼˜åŒ– |

## æ¶æ„

```
å®¢æˆ·ç«¯ â†’ è°ƒåº¦å™¨ â†’ Worker é›†ç¾¤ (500+ å°æœºå™¨)
         â†‘
         â””â”€ å¿ƒè·³ (æ¯3ç§’)
```

è¯¦è§[è®¾è®¡æ–‡æ¡£](docs/plans/2025-12-14-distributed-scheduler-design.md)

## å¿«é€Ÿå¼€å§‹

### 1. æ„å»º

```bash
go build -o scheduler ./cmd/scheduler
go build -o worker ./cmd/worker
```

### 2. å¯åŠ¨è°ƒåº¦å™¨

```bash
./scheduler --port=8080
```

### 3. å¯åŠ¨ Worker

```bash
# GPU Worker
./worker --id=worker-001 --addr=192.168.1.100:9000 --tags=gpu,cuda-12.0 --max-tasks=30

# CPU Worker
./worker --id=worker-002 --addr=192.168.1.101:9000 --tags=cpu,avx2 --max-tasks=30
```

### 4. è°ƒåº¦ä»»åŠ¡

```bash
curl -X POST http://localhost:8080/api/v1/schedule \
  -H "Content-Type: application/json" \
  -d '{"task_id":"task-001","required_tags":["gpu"]}'
```

å“åº”:
```json
{
  "worker_id": "worker-001",
  "address": "192.168.1.100:9000"
}
```

## API æ–‡æ¡£

è¯¦è§ [API æ–‡æ¡£](docs/api.md)

## æµ‹è¯•

```bash
# å•å…ƒæµ‹è¯•
go test ./...

# é›†æˆæµ‹è¯•
go test ./tests -v
```

## ä½¿ç”¨åœºæ™¯

- **éŸ³é¢‘å¤„ç†**: å¤§è§„æ¨¡éŸ³é¢‘è½¬ç ã€é™å™ªã€ç‰¹å¾æå–
- **è§†é¢‘å¤„ç†**: è§†é¢‘è½¬ç ã€å‰ªè¾‘ã€AI å¢å¼º
- **AI æ¨ç†**: æ¨¡å‹æ¨ç†ä»»åŠ¡åˆ†å‘åˆ° GPU é›†ç¾¤
- **æ•°æ®å¤„ç†**: å¤§æ‰¹é‡æ•°æ®æ¸…æ´—ã€è½¬æ¢ä»»åŠ¡
- **ç§‘å­¦è®¡ç®—**: åˆ†å¸ƒå¼è®¡ç®—ä»»åŠ¡è°ƒåº¦

## æŠ€æœ¯æ ˆ

- **è¯­è¨€**: Go 1.21+
- **ä¾èµ–**: ä»…æ ‡å‡†åº“ (net/http, encoding/json, sync ç­‰)
- **åè®®**: HTTP/REST (heartbeat å’Œ scheduling API)
- **å¹¶å‘**: goroutines + context + sync.RWMutex
- **æµ‹è¯•**: æ ‡å‡† testing åŒ… + table-driven tests

## è°ƒåº¦ç®—æ³•

1. **èµ„æºæ ‡ç­¾è¿‡æ»¤**: ç­›é€‰åŒ…å«æ‰€æœ‰å¿…éœ€æ ‡ç­¾çš„ Worker
2. **å¯ç”¨æ€§è¿‡æ»¤**: æ’é™¤ç¦»çº¿æˆ–æ»¡è½½çš„ Worker
3. **è´Ÿè½½æ’åº**: æŒ‰è´Ÿè½½ç‡ (å½“å‰ä»»åŠ¡æ•°/æœ€å¤§ä»»åŠ¡æ•°) å‡åºæ’åº
4. **é€‰æ‹©æœ€ä¼˜**: é€‰æ‹©è´Ÿè½½ç‡æœ€ä½çš„ Worker
5. **ä¹è§‚åˆ†é…**: ç«‹å³å¢åŠ ä»»åŠ¡è®¡æ•°,ç”±ä¸‹æ¬¡å¿ƒè·³æ ¡æ­£

## é¡¹ç›®ç»“æ„

```
dtask-scheduler/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ scheduler/      # è°ƒåº¦å™¨å…¥å£
â”‚   â””â”€â”€ worker/         # Worker å…¥å£
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ scheduler/      # è°ƒåº¦å™¨æ ¸å¿ƒé€»è¾‘
â”‚   â”‚   â”œâ”€â”€ algorithm.go   # è°ƒåº¦ç®—æ³•
â”‚   â”‚   â”œâ”€â”€ handlers.go    # HTTP å¤„ç†å™¨
â”‚   â”‚   â””â”€â”€ state.go       # çŠ¶æ€ç®¡ç†
â”‚   â””â”€â”€ worker/         # Worker æ ¸å¿ƒé€»è¾‘
â”‚       â””â”€â”€ heartbeat.go   # å¿ƒè·³å‘é€å™¨
â”œâ”€â”€ pkg/
â”‚   â””â”€â”€ types/          # å…±äº«ç±»å‹å®šä¹‰
â”œâ”€â”€ tests/              # é›†æˆæµ‹è¯•
â””â”€â”€ docs/               # æ–‡æ¡£
```

## å¼€å‘è·¯çº¿å›¾

- [x] **MVP**: å•è°ƒåº¦å™¨ + å¿ƒè·³æœºåˆ¶ + åŸºç¡€è°ƒåº¦
- [ ] **é«˜å¯ç”¨**: ä¸»å¤‡è°ƒåº¦å™¨ + æ•…éšœåˆ‡æ¢
- [ ] **ç›‘æ§**: Prometheus æŒ‡æ ‡ + Grafana ä»ªè¡¨ç›˜
- [ ] **æ ‡ç­¾ç´¢å¼•**: å€’æ’ç´¢å¼•åŠ é€Ÿèµ„æºè¿‡æ»¤
- [ ] **ç­‰å¾…é˜Ÿåˆ—**: èµ„æºä¸è¶³æ—¶çš„ä»»åŠ¡æ’é˜Ÿ
- [ ] **ä»»åŠ¡ä¼˜å…ˆçº§**: æ”¯æŒé«˜ä¼˜å…ˆçº§ä»»åŠ¡æ’é˜Ÿ
- [ ] **èµ„æºé¢„ç•™**: ç»†ç²’åº¦çš„ CPU/å†…å­˜/GPU æ˜¾å­˜é¢„ç•™

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request!

## è®¸å¯è¯

MIT License - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶
